---
layout: post
title: "ì½ê¸° ì „ìš© DTO ì¡°íšŒ ì‹œ JOINì˜ Pagination ê¸°ë²•"
description: >
  JPAì˜ ê¸°ë³¸ ì‚¬í•­ì„ ì •ë¦¬í•œë‹¤.
image: /assets/img/study/jpa.jpg
categories: [ study,jpa ]
related_posts:

---

* toc
{:toc}


# ì½ê¸° ì„¸íŠ¸ DTO + JOIN ì‹œ Pagination ê¸°ë²•

JPAì—ì„œ ì¶”í›„ ì—”í‹°í‹°ì— ëŒ€í•œ ìˆ˜ì •ì´ í•„ìš”ì—†ì„ ê²½ìš°, Lazy Loadingì— ëŒ€í•œ Transaction ìœ ì§€ë‚˜ ì„±ëŠ¥ì ì¸ ë©´ (ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìŠ¤ëƒ…ìƒ· ìƒì„±, ê°€ë¹„ì§€ ì»¬ë ‰í„° ì²˜ë¦¬, ì†ë„) ì ì¸ ë©´ì—ì„œ<br>
ì½ê¸°ë§Œ í•  ê²½ìš° JOIN + í”„ë¡œì ì…˜(DTO)ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.<br>
ê·¸ëŸ¬ë‚˜ ë§ì€ ì½ê¸°ëŠ” Paginationì´ í•„ìš”í•œ ê²½ìš°ê°€ ë§ë‹¤.<br>
JOIN + í”„ë¡œì ì…˜(DTO)ì—ì„œ Paginationì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì.<br>

## ì½ê¸° ì „ìš© ì„¸íŠ¸ DTO ì˜ˆì‹œ

~~~java
//file: `Author Entity ì˜ˆì‹œ`
@Entity
public class Author{
    @Id
    @GeneratedValue
    private Long id;
    private String name;
    private int age;
    
    @OneToMany(mappedBy = "author")
    private List<Book> books = new ArrayList<>();
}
~~~

~~~java
//file: `Book Entity ì˜ˆì‹œ`
@Entity
public class Book{
    @Id
    @GeneratedValue
    private Long id;
    private String title;
    private String isbn;
    
    @ManyToOne
    private Author author;
}
~~~

~~~java
//file: `ì½ê¸° ì „ìš© DTO`
public interface AuthorBookDto{
    Stirng getName();//author ì •ë³´
    int getAge();//author ì •ë³´
    String getTitle();//Book ì •ë³´
    String getIsbn();//Book ì •ë³´
}
~~~


Author(ë¶€ëª¨) - Books(ìì‹) ê´€ê³„ì—ì„œ Authorì˜ ì •ë³´ì™€ Bookì˜ ì •ë³´ë¥¼ í•¨ê»˜ ì¡°íšŒ'ë§Œ' í•´ì•¼ í•˜ëŠ” ìƒí™©ì´ë¼ë©´ ì–´ë–»ê²Œ ë ê¹Œ?<br>

## Join + Projection(DTO) + Page ê°ì²´ì‚¬ìš©

~~~java
//file: `AuthorRepository`
@Repository
@Transactional(readOnly = true)
public interface AuthorRepository extends JpaRepository<Author, Long>{
    
    @Query("SELECT a.name AS name, a.age AS age, b.title AS title, b.isbn AS isbn " +
            " FROM Author a LEFT JOIN a.books b" +
            " WHERE a.genre = ?1")
    Page<AuthorBookDto> findByViaQuerySimpleDto(Pageable pageable);
}
~~~

~~~java
//file: `Serviceì—ì„œ ì‚¬ìš©`
public Page<AuthorBookDto> fetchPageOfAuthorsWithBooksDtoByGenre(int page, int size){
    
    Pageable pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.ASC,"name"));
    Page<AuthorbookDto> pageOfAuthors = fetchPageOfAuthorsWithBooksDtoByGenre("Anthology",pageable);
    return pageOfAuthors;
        }
~~~

ì¿¼ë¦¬ëŠ” Authorì™€ Booksì˜ LEFT OUTER JOIN SELECT í•˜ë‚˜, COUNT í•˜ë‚˜ë¡œ 2ê°œì˜ SELECTë¬¸ì´ ë°œìƒëœë‹¤.<br>
Projectionì„ í†µí•´ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì— Author - Book 1:1 ê´€ê³„ë¡œ ê°€ì ¸ì˜¨ë‹¤.<br>
ì˜ˆë¥¼ë“¤ë©´ ì•„ë˜ì™€ ê°™ë‹¤.<br>

~~~json
"content":[
        {
            "title" : "title1",
            "isbn" : "001-MJ"
            "age" : 23,
            "name" : "Mark Janel"
        },
        {
            "title" : "title2",
            "isbn" : "002-MJ"
            "age" : 23,
            "name" : "Mark Janel"
        }
~~~
ë™ì¼í•œ Author ë”ë¼ë„ ì±…ì— ë”°ë¼ 1ê°œì˜ countingì„ ì°¨ì§€í•œë‹¤.<br>

---

## [ì„±ëŠ¥ ê°œì„  1] COUNT(*) OVER() ìœˆë„ìš° í•¨ìˆ˜ ì‚¬ìš©ìœ¼ë¡œ `SELECT + COUNT 1ê°œì˜ SELECT`ë¡œ ì²˜ë¦¬

### STEP 1. Projectionì— ë©”ì„œë“œ ì¶”ê°€
getTotalì„ @JsonIgnore ì„¤ì •ê³¼ í•¨ê»˜ ì¶”ê°€í•´ì¤€ë‹¤.
~~~java
//file: `methodì¶”ê°€ëœ ì½ê¸° ì „ìš© DTO`
public interface AuthorBookDto{
    Stirng getName();//author ì •ë³´
    int getAge();//author ì •ë³´
    String getTitle();//Book ì •ë³´
    String getIsbn();//Book ì •ë³´
    
    @JsonIgnore
    long getTotal();
}
~~~

### STEP 2. COUNT(*) OVER() ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ í˜¸ì¶œ
COUNT(*) OVER()ë¥¼ totalë¡œ ë°›ê¸° ìœ„í•´ nativeQueryë¡œ ìˆ˜ì •í•´ì¤€ë‹¤.<br>
Pageê°ì²´ê°€ ì•„ë‹Œ, Listë¡œ ë°›ëŠ”ë‹¤ëŠ” ì ì„ ì£¼ì˜<br>
~~~java
//file: `AuthorRepository`
@Transaction(readOnly = true)
@Query(value = "SELECT a.name AS name, a.age AS age, b.title AS title, b.sibn AS isbn," +
        "COUNT(*) OVER() AS total" +
        "FROM author a LEFT JOIN book b" +
        "ON a.id = b.author_id WHERE a.genre = ?1", nativeQuery = true)
List<AuthorBookDto> fetchListOfDtoNative(String genre, Pageable pageable);
~~~

### STEP 3. SERVICE ì—ì„œ ì‚¬ìš© ìˆ˜ì •
Listë¡œ SELECT 1ê°œë§Œ ë°œìƒí•˜ëŠ” ìµœì í™” ëœ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°€ì ¸ì˜¤ê³  Page ê°ì²´ë¥¼ Listë¡œ ë³€ê²½í•´ì¤€ë‹¤.<br>
~~~java
//file: `Serviceì—ì„œ ì‚¬ìš©`
public Page<AuthorBookDTo> fetchPageOfAuthorsWithBooksDtoByGenre(int page, int size){
    
    Pageable pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.ASC,"name"));
    List<AuthorbookDto> list = fetchListOfDtoNative("Anthology",pageable);

    return new PageImpl<>(list, pageable, list.isEmpty() ? 0 : list.get(0).getTotal());
}
~~~

~~~sql
--file: `ë°œìƒ ì¿¼ë¦¬`
SELECT
    a.name AS name,
    a.age AS age,
    b.title AS title,
    b.isbn AS isbn,
    COUNT(*) OVER() AS total
FROM author a LEFT JOIN book b 
    ON a.id = b.author_id
WHERE a.genre = ?
ORDER BY a.name ASC LIMIT ? ?
    
~~~

---



## [ì„±ëŠ¥ ê°œì„  2] ì¶”ê°€ ì‚­ì œê°€ ë§¤ìš° ë“œë¬¸ ê²½ìš°, Slice ì‚¬ìš©
ì‹ ê·œ ë“±ë¡ì´ë‚˜ ì‚­ì œê°€ ë§¤ìš° ë“œë¬¸ ê²½ìš°ì— ê° í˜ì´ì§€ë¥¼ í˜¸ì¶œí•  ë•Œ ë§ˆë‹¤ SELECT COUNTë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì€ ë¹„íš¨ìœ¨ì ì´ë‹¤.<br>
í–‰ ìˆ«ìê°€ ì˜¤ë«ë™ì•ˆ ê³ ì •ëœ ìƒíƒœë¡œ ìœ ì§€ë˜ê¸° ë•Œë¬¸ì´ë‹¤.<br>
ì´ ê²½ìš°, ì²« ë²ˆì§¸ í˜ì´ì§€ë¥¼ ê°€ì ¸ì˜¬ ë•Œ ë‹¨ì¼ SELECT COUNTë¥¼ íŠ¸ë¦¬ê±° í•˜ê³  í˜ì´ì§€ë„¤ì´ì…˜ì— Slice or Listë¥¼ ì‚¬ìš©í•œë‹¤.<br>

### STEP 1. Repository Sliceë¡œ ë³€ê²½

~~~java
@Transactional(readOnly = true)
@Query(value = "SELECT a.name AS name, a.age AS age, b.title AS title, b.sibn AS isbn," +
        "FROM author a LEFT JOIN book b" +
        "ON a.id = b.author_id WHERE a.genre = ?1")
Slice<AuthorBookDto> fetchSliceOfDto(String genre, Pageable pageable);
~~~

### STEP 2. SERVICE ì—ì„œ ì‚¬ìš© ìˆ˜ì •
Slice íƒ€ì…ì€ size + 1ì˜ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¨ë‹¤.<br>
ì²« í˜ì´ì§€ì¸ì§€ í™•ì¸í•˜ëŠ” isFirst(), ë‹¤ìŒ í˜ì´ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” hasNext()ë©”ì„œë“œë¥¼ ì œê³µí•œë‹¤.<br>
~~~java
public Slice<AuthorBookDto> fetchSliceOfAuthorsWithBooksDtoByGenre(int page, int size){
    Pageable pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.ASC,"name"));
    return authorRepository.fetchSliceOfDto("Anthology", pageable);
        }
~~~

COUNT ìì²´ê°€ ì—†ëŠ” ì¿¼ë¦¬ê°€ ë°œìƒí•œë‹¤.<br>
~~~sql
--file: `ë°œìƒ ì¿¼ë¦¬`
SELECT
    a.name AS name,
    a.age AS age,
    b.title AS title,
    b.isbn AS isbn
FROM author a LEFT OUTER JOIN book b 
    ON a.id = b.author_id
WHERE a.genre = ?
ORDER BY a.name ASC LIMIT ? ?
    
~~~

---


## [ë¬¸ì œ ìƒí™© 1] ê²°ê³¼ ì„¸íŠ¸ ì˜ë¦¼ ë°©ì§€
ì½ê¸° ì „ìš© DTOë¥¼ ì‚¬ìš©í•´ì„œ ê°€ì ¸ì˜¤ë©´ ê²°ê³¼ ì„¸íŠ¸ê°€ ì˜ë¦´ ìˆ˜ ìˆë‹¤.<br>
ì•ì—ì„œ ë´¤ë“¯ì´, Author - Book 1ê°œì”© ë¬¶ì–´ì„œ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì—, ì˜ˆë¥¼ ë“¤ë©´ Mark Janelì´ ì“´ ì±…ì´ 3ê¶Œì´ ìˆëŠ”ë° 1,2ê¶Œì€ 1í˜ì´ì§€, 3ê¶Œì€ 3í˜ì´ì§€ì— ë‚˜ì˜¬ ìˆ˜ ìˆë‹¤.<br>
ì´ëŸ° ìƒí™©ì„ `ê²°ê³¼ ì„¸íŠ¸ ì˜ë¦¼`ì´ë¼ê³  í•œë‹¤.<br>
~~~json
"content":[
        {
            "title" : "title1",
            "isbn" : "001-MJ"
            "age" : 23,
            "name" : "Mark Janel"
        },
        {
            "title" : "title2",
            "isbn" : "002-MJ"
            "age" : 23,
            "name" : "Mark Janel"
        },//ì—¬ê¸°ê¹Œì§€ 1í˜ì´ì§€ ì˜ë¦¼
        {
            "title" : "title3",
            "isbn" : "003-MJ"
            "age" : 23,
            "name" : "Mark Janel"
        }//ì—¬ê¸°ì„œ 2í˜ì´ì§€
~~~

ğŸ’¡ê·¸ëŸ¼, ì±…ì˜ ê°œìˆ˜ê°€ ì•„ë‹ˆë¼ ì €ìì˜ ê°œìˆ˜ë¡œ countingí•˜ì—¬ ìë¥¼ ìˆœ ì—†ì„ê¹Œ?<br>

* DENSE_RANK()ë€? : ì¡°ì¸í•˜ëŠ” ë‘ í…Œì´ë¸”ì„ A(Author),B(Book) ì´ë¼ê³  í•  ë•Œ, ê° ì €ìë³„ë¡œ ì±…ì„ ë‚˜ì—´í•˜ê³ , ê°™ì€ ìˆœì„œë¥¼ ë§¤ê¸´ë‹¤.<br> 

### STEP 1. DENSE_RANK() Native ì‚¬ìš©
ì¼ë°˜ì ìœ¼ë¡œ ë³µì¡í•œ ì¿¼ë¦¬ëŠ” Native ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•œë‹¤.
~~~java
//file: `AuthorRepository`
@Transactional(readOnly = true)
@Query(value = """SELECT * FROM (
                     SELECT *, DENSE_RANK() OVER (ORDER BY name, age) na_rank FROM(
                        SELECT a.name AS name, a.age AS age, b.title AS title, b.isbn AS isbn
                        FROM author a LEFT JOIN book b ON a.id = b.author_id
                        WHERE a.genre = ?1
                        ORDER BY a.name) ab ) ab_r
                      WHERE ab_r.na_rank > ?2 AND ab_r.na_rank <= ?3""", nativeQuery = true)
List<AuthorBookDto> fetchListOfDtoNativeDenseRank(String genre, int start, int end);
~~~

na_rankì˜ ì´ ê°œìˆ˜ëŠ” ë™ì¼í•œ ì¡°ê±´ì˜ author ê°œìˆ˜ì™€ ë™ì¼í•˜ë‹¤.<br>


name    | age | title | isbn    | na_rank
--------|-----|-------|---------|---------
Alice   | 30  | Book1 | ISBN001 | 1
Alice   | 30  | Book4 | ISBN004 | 1
Bob     | 25  | Book2 | ISBN002 | 2
Charlie | 35  | Book3 | ISBN003 | 3
name,age ê¸°ì¤€ìœ¼ë¡œ ë™ì¼í•œ na_rankê°€ ë¶€ì—¬ë˜ì—ˆë‹¤.
{:.figcaption}


### STEP 2. Service ì—ì„œ ì‚¬ìš©ë²•
~~~java
//file: `Service`
public List<AuthorBookDto> fetchListOfAuthorsWithBooksDtoNativeDenseRank(int start, int end){
    List<AuthorBookDto> listOfAuthors = authorRepository.fetchListOfDtoNativeDenseRank("Anthology", start, end);
    return listOfAuthors;
}
~~~


